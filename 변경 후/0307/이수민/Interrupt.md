# 인터럽트란?
- 주변장치와 입출력 장치는 CPU나 메모리와 달리 인터럽트라는 메커니즘을 통해 관리된다. 
- CPU가 프로그램을 실행하고 있을 때, 입출력 HW 등의 장치나 예외상황이 발생하여 처리가 필요할 경우에 마이크로프로세서에게 알려 처리할 수 있도록 하는 것이다. 


</br>
=> 프로그램 실행 중에 CPU의 현재 처리 순서를 중단하고, 다른 동작을 수행하도록 요구하는 것이다. 즉, Interrupt가 발생하면 OS는 CPU에게 그동안 하고 있는 일들을 멈추게 하고, 해결하도록 한다. </br>

</br>
인터럽트가 발생하면 ISR(Interrupt Service Routines)라는 것이 실행되는데, 이를 인터럽트 핸들러(Interrupt Handler)라고 한다. </br>
예외상황에 대한 처리가 필요한 상황에 발생한다. </br>
예외상황에 따라 인터럽트는 (1) 외부 Interrupt (2) 내부 Interrupt (3) SW Interrupt 나뉜다. </br>

</br>

## (1) External Interrupt (외부 인터럽트)
- CPU 코어 외부 요인으로 발생하는 것을 의미하는데, 전기적인 신호로 CPU에게 Interrupt를 거는 경우로 전원이상 인터럽트, I/O 인터럽트, 타이머 인터럽트가 있다.
- System과 연결된 외부 I/O (USB, UART) 등으로부터 전송되는 data의 시작이나 종료를 알리는 경우, 혹은 기타 버튼에 의해 제어되는 경우 </br>

1. 전원 이상 interrupt
-> 갑자기 전원 공급이 중단되는 경우 CPU에 Interrupt를 걸어 작업 중이던 프로세스를 대피시킬 수 있도록 한다. </br>

2. I/O Interrupt
-> CPU가 I/O 장치(키보드, 마우스, 프린터 등)에게 일을 맡기거나 I/O 장치가 CPU에게 정보를 전달해 줄 때 호출된다. 

3. 타이머 Interrupt 
-> 컴퓨터 내부의 타이머가 CPU에 주기적으로 expried 되었다고 알림을 주는데, 이것이 Interrupt이다. </br>
-> 따라서 하나의 프로그램이 CPU 자원을 너무 오래 점유하지 못하도록 한다. </br>
-> 또한, 무한루프가 도는 프로그램의 경우에도 종료 할 수 있고 Contect Switch가 발생한다. </br>
-> 타이머 Interrupt는 100hz로 인터럽트를 건다. (10ms 마다 Interrupt가 걸린다.) </br>

## (2) Inner Interrupt (내부 인터럽트)
- CPU 코어 내부에서 프로그램이 실행되면서 Interrupt에 걸리는 경우로 프로그램 검사 인터럽트이다. (Exception Interrupt, Trap)
#### Exception interrupt(Trap) 
- Division by zero
- Overflow/Underflow
- 기타 프로그램 Exception

### Exception 
-> SW 내부에서 예외상황을 처리하는 것을 두고 SW Interrupt를 Exception으로 보는 경우도 있다.

### Trap 
-> 특별한 조건을 걸어두고 조건에 부합하는 경우 상황에 맞는 Service Routine이나 Handler가 실행 되도록 하는 것을 의미한다. </br>
따라서 이 경우에는 ISR(Interrupt Service Routine) or 인터럽트 핸들러(Interrupt Handler)가 된다. </br>


## (3) SW Interrupt 
- SW Interrupt는 프로그램 처리 중 명령의 요청에 의해 발생하는 경우로 SVC(SuperVisor Call) - 감시 프로그램이 있다. </br>

일반적으로 응용 프로그램은 User Mode에 실행 되는데, 이 경우 직접 접근할 수 있는 자원에 제한이 있다. </br>
이러한 자원에 접근하는 명령어는 Supervisor만 실행할 수 있어야하고, Kernel Mode이다. </br>
즉, 응용프로그램이 SuperVisor Call을 통해 허락을 맡은 후 Supervisor Mode(= Kernel Mode)로 변경하고, 해당 멸령을 실행 후, 다시 User Mode로 변경하는 과정을 거친다. </br>

운영체제가 제공하는 서비스에 대한 프로그래밍 인터페이스가 System Call이고, System Call을 실행시키기 위한 CPU 명령어가 SVC이다. 

</br> ((예시))
특정 Application program에서 메모리 접근 권한이나 기타 I/O 디바이스의 자원 할당을 위해 접근 권한을 요청하는 경우 카메라 어플리케이션을 설치 후 실행했을 때 메모리나 카메라에 접근 권한을 요청하는 팝업이 뜬다. </br>
이때 SVC라 부르며 application은 System의 자원에 접근할 수 없기 때문에 OS를 통해 application이 사용할 자원을 할당해주는 일을 수행한다. 


## Why?
- 입출력 연산이 CPU 명령 수행속도보다 현저히 느리기 때문이다. 

</br>

### 예시 
스마트폰을 이용해 유튜브를 시청하고 있는데, 갑자기 전원 버튼을 누르면 화면이 꺼지면서 대기 상태로 돌아가게 된다. </br>

이렇게 전원을 누르는 행위는 프로그램에서 예기치 않은 문제라고 하고, 인터럽트를 발생시킬 수 있는 인터럽트 소스가 될 수 있다. </br>

프로그램이 유튜브 영상을 재생하기 위해서 CPU는 이러한 일을 한다. </br>



## 인터럽트 처리 과정

</br>

![image](https://user-images.githubusercontent.com/58407737/223398119-e786d1cd-0c9d-4b58-a73b-8bdba39dc014.png)

### 요청 -> 중단 -> 보관 -> 인터럽트 처리 -> 재개

Process A 실행 중 디스크에서 어떤 데이터를 읽어오라는 명령을 받았다. 라는 가정

1. Process A는 system call을 통해 인터럽트 발생시킨다. 

2. 현재 진행 중인 기계어 코드를 완료하며 프로그램 실행 중단한다. 

3. 현재 실행 중인 프로그램 상태를 PCB, PC에 저장한다.
(PCB는 수행중이던 Memory 주소, 레지스터 값, 하드웨어 상태 등), (PC는 다음에 실행할 명령의 주소를 저장)

4. 인터럽트 원인을 판별한다.
(인터럽트 요청한 장치를 식별하여 원인 파악후 Interrupt Vector 테이블을 참조하여 호출할 ISR(인터럽트 서비스 루틴) 주소 값을 얻는다. </br>

* 인터럽트 백터: 인터럽트 발생 시 처리해야할 인터럽트 핸들러의 주소를 인터럽트 별로 보관하고 있는 테이블이다. 

5. ISR 처리한다.
(서비스 루틴 수행 중, 우선순위가 더 높은 인터럽트가 발생하면 재귀적으로 1~5과정을 수행한다.) </br>

* ISR(Interupt Service Routine) = Interrupt Handler </br>
실제 인터럽트를 처리하기 위한 루틴으로 OS 코드 영역에는 인터럽트별로 처리해야할 내용이 이미 프로그램되어 있다. </br>

인터럽트 서비스 루틴을 실행할 때 인터럽트 플래그 (IF)를 0으로 하면 인터럽트 발생을 방지할 수 있다. </br>
(인터럽트 요청 신호가 들어와도 AND Gate를 통과하지 못한다.) </br>

6. 상태 복구
해당 일을 다 처리하여 상태 복구 명령어가 실행되면, 대피시킨 레지스터를 복원한다. </br>
ISR의 끝에 IRET 명령어(대피 시킨 PC 값을 되돌리며, 이전 실행위치로 돌아간다.)로 이전 실행 위치 복원한다. </br>

7. 중단된 프로그램 실행 재개
PCB의 값을 이용하여 이전에 수행 중이던 프로그램을 재개한다. 


## 인터럽트 우선순위
여러 장치에서 인터럽트가 동시에 발생하거나, 인터럽트 서비스 루틴 수행 중 인터럽트가 발생한 경우 우선순위 판별 필요
![image](https://user-images.githubusercontent.com/58407737/223398462-ca1195cf-a954-44b8-b986-ad98114559d4.png)

</br>

일반적으로 HW 인터럽트가 SW 인터럽트보다 우선 순위가 높고, 내부 인터럽트 보다 외부 인터럽트가 우선 순위가 높다. </br>


### 인터럽트 
* 프로그램 실행 중에 CPU의 현재 처리 순서를 중단하고, 다른 동작을 수행하도록 요구하는 것이다.
* 인터럽트가 발생하면 OS는 CPU에게 그동안 하고 있는 일들을 멈추고 Interrupt를 해결하도록 한다.

### System Call
* 프로세스가 특권 명령을 실행하기 위해 커널 모드로의 전환을 요청하는 인터페이스를 시스템 콜이라고 한다. 시스템 콜은 Trap의 한 종류이기도 하다.
* OS의 서비스들을 사용 간으하게 해주는 인터페이스들을 제공한다. 
